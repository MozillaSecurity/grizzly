<!DOCTYPE html>
<html>
<head>
<meta charset=UTF-8>
<title>&#x1f43b; &sdot; Grizzly &sdot; &#x1f98a;</title>
<script>
function grzDump(msg) {
  dump(`[grizzly harness][${new Date().toUTCString()}] ${msg}`)
}

function setBanner(msg) {
  try { document.getElementById('banner').innerHTML = msg } catch(e) { grzDump(`setBanner error: ${e}`) }
}

function main() {
  if (sub !== null && !sub.closed) {
    setTimeout(main, 10)
    return
  }

  if (close_after !== undefined && close_after-- < 1) {
    grzDump('Hit close limit.\n')
    window.location = '/close_browser'
    return
  }

  // open test
  sub = open((sub !== null) ? '/next_test' : '/first_test', 'GrizzlyFuzz')
  if (sub === null) {
    setBanner('Error! Could not open window. Blocked by the popup blocker?')
    grzDump('Could not open test! Blocked by the popup blocker?')
    return
  }

  sub.addEventListener('DOMContentLoaded', function () {
    try { cur_loc = sub.location.toString() } catch (e) { cur_loc = prev_loc }
  })

  sub.addEventListener('unload', function () {
    clearTimeout(limit_tmr)
    grzDump('Test case closed\n')
    // check if we are reopening the same page
    // this seems to be due to losing sync with the web server
    if (cur_loc === prev_loc && cur_loc !== orig_loc) {
      if (++retries > 2) {
        grzDump('Lost sync! Closing Browser.')
        window.location = '/close_browser'
        return
      }
    } else {
      if (orig_loc === undefined) {
        // set origin location to detect if we are fuzzing (moving) or reducing
        orig_loc = cur_loc;
      }
      prev_loc = cur_loc
      retries = 0
    }
    setTimeout(main, 0)
  })
  limit_tmr = setTimeout(() => {
    grzDump('Time limit exceeded\n')
    if (!sub.closed){
      grzDump('Closing test case\n')
      sub.close()
    }
  }, time_limit)
}

let close_after, limit_tmr, orig_loc, prev_loc, time_limit
let retries = 0
let sub = null
let cur_loc
for (let kv of location.hash.substr(1).split(',')) {
  let [k, v] = kv.split('=')
  if (k === 'timeout') {
    time_limit = Number(v)
  } else if (k === 'close_after') {
    close_after = Number(v)
  } else {
    grzDump(`unknown arg: ${k}`)
  }
}
if (time_limit === undefined || time_limit <= 0) {
  grzDump('No time limit given, using default of 5s\n')
  time_limit = 5000
} else {
  grzDump(`Using time limit of ${time_limit}\\n`)
}

window.onload = () => {
  // update banner
  setBanner('&#x1f43b; &sdot; Grizzly Harness &sdot; &#x1f98a;')
  main()
}

window.addEventListener('beforeunload', () => {
  clearTimeout(limit_tmr)
  grzDump('Cleaning up\n')
  if (!sub.closed) {
    sub.close()
  }
})
</script>
</head>
<body style='background-color:#E5E4E2'>
<h4 id='banner'>&#x1f43b; &sdot; Loading...</h4>
</body>
</html>
