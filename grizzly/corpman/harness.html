<!DOCTYPE html>
<html>
<head>
<meta charset=UTF-8>
<title>&#x1f43b; &sdot; Grizzly &sdot; &#x1f98a;</title>
<script>
function grz_dump(msg){
  dump('[grizzly harness][' + new Date().toGMTString() + '] ' + msg);
}
let limit_tmr, close_after, closed_tmr, sub, time_limit;
let kvps = location.hash.substr(1).split(",")
for (let entry in kvps) {
  let kv = kvps[entry].split("=");
  if (kv[0] == "timeout") {
    time_limit = Number(kv[1]);
  }
  else if (kv[0] == "close_after") {
    close_after = Number(kv[1]);
  }
}
let req_url = '/first_test';
let prev_url = null;
if (time_limit == undefined || time_limit <= 0) {
  grz_dump('No time limit given, using default of 5s\n');
  time_limit = 5000;
} else {
  grz_dump('Using time limit of ' + time_limit + '\n');
}
let main = function(){
  let is_done = false;
  if (close_after != undefined) {
    close_after--;
  }
  sub = open(req_url, 'GrizzlyFuzz');
  sub.addEventListener('beforeunload', function(){
    closed_tmr = setInterval(function(){
      if (!is_done && sub.closed) {
        clearTimeout(limit_tmr);
        clearInterval(closed_tmr);
        is_done = true;
        grz_dump('Test case closed itself\n');
        if (close_after != undefined && close_after < 1) {
          window.close();
        }
        else {
          setTimeout(main, 0);
        }
      }
    }, 10);
  });
  limit_tmr = setTimeout(function(){
    if (!is_done) {
      clearInterval(closed_tmr);
      is_done = true;
      grz_dump('Time limit exceeded\n');
      let cur_loc = null;
      if (!sub.closed && sub.location != null){
        cur_loc = sub.location.toString();
      }
      if (cur_loc != null && cur_loc == prev_url){
        // TODO: figure out why this happens
        grz_dump('Potential browser/fuzzer sync issue detected\n');
        grz_dump('Continued to request: ' + cur_loc + '\n');
        prev_url = null;
        req_url = '/first_test';
      }
      else {
        prev_url = cur_loc;
      }
      if (!sub.closed){
        grz_dump('Closing test case\n');
        sub.close();
      }
      if (close_after != undefined && close_after < 1) {
        window.close();
      }
      else {
        setTimeout(main, 0);
      }
    }
  }, time_limit);
  req_url = '/next_test';
};
window.onload = main;
window.addEventListener('beforeunload', function(){
  clearInterval(closed_tmr);
  clearTimeout(limit_tmr);
  grz_dump('Cleaning up\n');
  if (!sub.closed) {
    sub.close();
  }
});
</script>
</head>
</html>
